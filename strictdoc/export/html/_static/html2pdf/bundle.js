(()=>{"use strict";const e={init:"[html2pdf]",pageDivider:"html2pdf-page",pageStartMarker:"[html2pdf-page-start]",style:"[html2pdf-style]",footerTemplate:"[html2pdf-footer]",headerTemplate:"[html2pdf-header]",frontpageTemplate:"[html2pdf-frontpage]",frontpageContent:"html2pdf-frontpage",headerContent:"html2pdf-header",footerContent:"html2pdf-footer",pageNumberRoot:"[html2pdf-page-number]",pageNumberCurrent:"[html2pdf-page-number-current]",pageNumberTotal:"[html2pdf-page-number-total]",root:"html2pdf-root",paperFlow:"html2pdf-paper-flow",contentFlow:"html2pdf-content-flow",virtualPaper:"html2pdf-virtual-paper",virtualPaperTopMargin:"html2pdf-virtual-paper-margin-top",virtualPaperBottomMargin:"html2pdf-virtual-paper-margin-bottom",virtualPaperGap:"html2pdf-virtual-paper-gap",paperBody:"html2pdf-paper-body",paperHeader:"html2pdf-paper-header",paperFooter:"html2pdf-paper-footer",runningSafety:"html2pdf-print-running",printPageBreak:"html2pdf-print-page-break",printIgnore:"[html2pdf-print-ignore]",printHide:"[html2pdf-print-hide]",neutral:"html2pdf-neutral",textNode:"html2pdf-text-node",complexTextBlock:"html2pdf-complex-text-block",printForcedPageBreak:"html2pdf-print-forced-page-break",flagNoBreak:"[html2pdf-flag-no-break]",flagNoHanging:"[html2pdf-flag-no-hanging]",topCutPart:".html2pdf-top-cut",bottomCutPart:".html2pdf-bottom-cut",tocPageNumber:"html2pdf-toc-page-number"};class t{constructor({DOM:e,debugMode:t}){this.debugMode=t,this.DOM=e,this.body=e.body,this.debugToggler={_DOM:!1}}createDocumentFragment(){return this.DOM.createDocumentFragment()}getElement(e,t=this.DOM){return t.querySelector(e)}getAllElements(e,t=this.DOM){return t.querySelectorAll(e)}getElementById(e,t=this.DOM){return t.getElementById(e)}removeNode(e){e.remove()}cloneNode(e){return e?.cloneNode(!0)}cloneNodeWrapper(e){return e?.cloneNode(!1)}replaceNodeContentsWith(e,...t){this.setInnerHTML(e,""),e.append(...t)}insertBefore(e,...t){e.before(...t)}insertAfter(e,...t){e.after(...t)}insertAtEnd(e,...t){e.append(...t)}insertAtStart(e,...t){e.prepend(...t)}insertInsteadOf(e,...t){e.before(...t),e.remove()}getRightNeighbor(e){return e.nextElementSibling}getLeftNeighbor(e){return e.previousElementSibling}getElementOffsetParent(e){return e.offsetParent}getDataId(e){return e.dataset.id}getAttribute(e,t){if(!e||!t)return void(this.debugMode&&this.debugToggler._DOM&&console.warn("setAttribute() must have 2 params"));const o=t.charAt(0);if("."!==o&&"#"!==o||this.debugMode&&this.debugToggler._DOM&&console.log(`you're really sure ${t} is attribute selector?`),"["===o){this.debugMode&&this.debugToggler._DOM&&console.assert("]"===t.at(-1),`the ${t} selector is not OK.`);const o=t.substring(1,t.length-1);return e.getAttribute(o)}e.getAttribute(t)}setAttribute(e,t,o){if(!e||!t)return void(this.debugMode&&this.debugToggler._DOM&&console.warn("setAttribute() must have 2 params"));const i=t.charAt(0);if("."!==i)if("#"!==i)if("["!==i)this.debugMode&&this.debugToggler._DOM&&console.log(`you're really sure ${t} is a selector?`);else{this.debugMode&&this.debugToggler._DOM&&console.assert("]"===t.at(-1),`the ${t} selector is not OK.`);const i=t.substring(1,t.length-1);e.setAttribute(i,o||"")}else{const o=t.substring(1);e.id=o}else{const o=t.substring(1);e.classList.add(o)}}removeAttribute(e,t){e.removeAttribute(t)}removeAllAttributes(e){for(;e.attributes.length>0;)e.removeAttribute(e.attributes[0].name)}removeAllClasses(e){e.classList=""}removeAllStyles(e){e.style=""}isSelectorMatching(e,t){if(!e||!t)return void(this.debugMode&&this.debugToggler._DOM&&console.warn("isSelectorMatching() must have 2 params","\n element: ",e,"\n selector: ",t));const o=t.charAt(0);if("."===o){const o=t.substring(1);return e.classList.contains(o)}if("#"===o){const o=t.substring(1);return e.id===o}if("["===o){this.debugMode&&this.debugToggler._DOM&&console.assert("]"===t.at(-1),`the ${t} selector is not OK.`);const o=t.substring(1,t.length-1);return e.hasAttribute(o)}return this.getElementTagName(e)===t.toUpperCase()}setFlagNoBreak(t){this.setAttribute(t,e.flagNoBreak)}setFlagNoHanging(t){this.setAttribute(t,e.flagNoHanging)}wrapTextNode(t){if(!this.isSignificantTextNode(t))return;const o=this.create(e.textNode);return t.before(o),o.append(t),o}isWrappedTextNode(t){return this.isSelectorMatching(t,e.textNode)}createNeutral(){return this.create(e.neutral)}createTestNodeFrom(e){const t=e.cloneNode(!1);return t.classList="test-node",t.style.position="absolute",t.style.background="rgb(255 239 177)",t.style.width=this.getMaxWidth(e)+"px",t}getMaxWidth(e){const t=this.create();e.append(t);const o=this.getElementWidth(t);return t.remove(),o}getLineHeight(e){const t=this.createNeutral();t.innerHTML="!",t.style.display="block",e.append(t);const o=t.offsetHeight;return t.remove(),o}getEmptyNodeHeight(e,t=!0){const o=this.create();t&&(o.style.padding="0.1px");const i=e.cloneNode(!1);o.append(i),e.before(o);const n=o.offsetHeight;return o.remove(),n}markPageStartElement(t,o){this.setAttribute(t,e.pageStartMarker,o)}unmarkPageStartElement(t){this.removeAttribute(t,e.pageStartMarker.substring(1,e.pageStartMarker.length-1))}isPageStartElement(t){return this.isSelectorMatching(t,e.pageStartMarker)}markPartNodesWithClass(t){t.forEach((t=>{t.classList.add(e.topCutPart.substring(1)),t.classList.add(e.bottomCutPart.substring(1))})),t.at(0).classList.remove(e.topCutPart.substring(1)),t.at(-1).classList.remove(e.bottomCutPart.substring(1))}getTableRowHeight(e,t=0){const o=e.offsetTop,i=e.cloneNode(!0),n="!<br />".repeat(t);[...i.children].forEach((e=>e.innerHTML=n)),e.before(i);const r=e.offsetTop;return i.remove(),r-o}createComplexTextBlock(){return this.create(e.complexTextBlock)}isComplexTextBlock(t){return this.isSelectorMatching(t,e.complexTextBlock)}getComputedStyle(e){return window.getComputedStyle(e)}isInline(e){const t=e.display;return"inline"===t||"inline-block"===t||"inline-table"===t||"inline-flex"===t||"inline-grid"===t}isInlineBlock(e){const t=e.display;return"inline-block"===t||"inline-table"===t||"inline-flex"===t||"inline-grid"===t}isGrid(e){return"grid"===e.display}isGridAutoFlowRow(e){const t=e.display,o=e.gridAutoFlow;return("grid"===t||"inline-grid"===t)&&"row"===o}isNeutral(t){return this.isSelectorMatching(t,e.neutral)}isForcedPageBreak(t){return this.isSelectorMatching(t,e.printForcedPageBreak)}insertForcedPageBreakBefore(t){const o=this.create(e.printForcedPageBreak);return this.insertBefore(t,o),o}insertForcedPageBreakAfter(t){const o=this.create(e.printForcedPageBreak);return this.insertAfter(t,o),o}findAllSelectorsInside(e,t){return"string"==typeof t&&(t=[t]),[...t].flatMap((t=>[...e.querySelectorAll(t)]))}isFirstChildOfFirstChild(e,t){if(!e||!e.parentElement)return!1;let o=e;for(;o.parentElement&&o!==t;){if(o.parentElement.firstElementChild!==o)return!1;o=o.parentElement}return o===t}isLastChildOfLastChild(e,t){if(!e||!e.parentElement)return!1;let o=e;for(;o.parentElement&&o!==t;){if(o.parentElement===t){let e=o.nextElementSibling;for(;!e.offsetHeight&&!e.offsetWidth;)if(e=e.nextElementSibling,this.isSelectorMatching(e,"[data-content-flow-end]"))return!0;return this.isSelectorMatching(e,"[data-content-flow-end]")}if(o.parentElement.lastElementChild!==o)return!1;o=o.parentElement}return o===t}findFirstChildParent(e,t){let o=e.parentElement,i=null;for(;o&&o!==t;){if(e!==o.firstElementChild)return i;i=o,o=(e=o).parentElement}return i}findLastChildParent(e,t){let o=e.parentElement,i=null;for(;o&&o!==t;){if(e!==o.lastElementChild)return i;i=o,o=(e=o).parentElement}return i}findAllForcedPageBreakInside(t){return[...t.querySelectorAll(e.printForcedPageBreak)]}isNoBreak(t){return this.isSelectorMatching(t,e.flagNoBreak)}isNoHanging(t){return this.isSelectorMatching(t,e.flagNoHanging)}findPreviousNoHangingsFromPage(e,t,o){let i=null,n=e.previousElementSibling;for(;this.getElementRootedTop(n,o)>t;){if(!this.isNoHanging(n))return i;if(this.isPageStartElement(n))return e;i=n,n=(e=n).previousElementSibling}return i}getElementTagName(e){return e.tagName}isDocumentBody(e){return"BODY"===e.tagName}isTextNode(e){return e.nodeType===Node.TEXT_NODE}isElementNode(e){return e.nodeType===Node.ELEMENT_NODE}isSignificantTextNode(e){return!!this.isTextNode(e)&&e.nodeValue.trim().length>0}clearTemplates(e){e.querySelectorAll("template").forEach((e=>e.remove()))}getParentNode(e){return e.parentNode}getChildNodes(e){return e.childNodes}getChildren(e){return e.children}getInnerHTML(e){if("string"==typeof e){const t=this.DOM.querySelector(e);return t?t.innerHTML:void 0}return e.innerHTML}setInnerHTML(e,t){if("string"==typeof e){const o=this.DOM.querySelector(e);o&&(o.innerHTML=t)}e.innerHTML=t}setStyles(e,t){Object.entries(t).forEach((([t,o])=>e.style[t]=o))}create(e,t){let o;if(e){const t=e.charAt(0);if("."===t){const t=e.substring(1);o=this.DOM.createElement("div"),o.classList.add(t)}else if("#"===t){const t=e.substring(1);o=this.DOM.createElement("div"),o.id=t}else if("["===t){const t=e.substring(1,e.length-1);o=this.DOM.createElement("div"),o.setAttribute(t,"")}else{if(!t.match(/[a-zA-Z]/))return void console.assert(!1,"Expected valid html selector ot tag name, but received:",e);o=this.DOM.createElement(e)}}else o=this.DOM.createElement("div");return t&&this.setInnerHTML(o,t),o}createPrintPageBreak(){return this.create(e.printPageBreak)}createWithFlagNoBreak(t){const o=this.create(e.flagNoBreak);return t&&(o.style=t),o}wrapNode(e,t){e.before(t),t.append(e)}wrapNodeChildren(e){const t=this.getChildren(e),o=this.create();return this.insertAtStart(o,...t),this.insertAtStart(e,o),o}wrapWithFlagNoBreak(e){const t=this.createWithFlagNoBreak();return e.before(t),t.append(e),t}fitElementWithinBoundaries({element:e,height:t,width:o,vspace:i,hspace:n}){const r=i/t,s=n/o,l=r<s?r:s,a=Math.trunc(t*l),g=Math.trunc(o*l);e.style.height=a+"px",e.style.width=g+"px",e.setAttribute("height",`${a}px`),e.setAttribute("width",`${g}px`)}getElementBCR(e){return e.getBoundingClientRect()}getElementTop(e){return e?.offsetTop}getElementLeft(e){return e?.offsetLeft}getElementHeight(e){return e?.offsetHeight}getElementWidth(e){return e?.offsetWidth}getElementRelativeTop(e){return e?.offsetTop}getElementRootedTop(e,t,o=0){if(!e)return void(this.debugMode&&this.debugToggler._DOM&&console.warn("element must be provided, but was received:",e,"\nThe function returned:",void 0));if(!t)return void(this.debugMode&&console.warn("root must be provided, but was received:",t,"\nThe function returned:",void 0));const i=e.offsetParent;if(!i)return void(this.debugMode&&this.debugToggler._DOM&&console.warn("Element has no offset parent.","\n element:",[e],"\n offsetParent:",i,"\n The function returned:",void 0));const n=e.offsetTop;return i===t?n+o:this.getElementRootedTop(i,t,o+n)}getElementRelativeBottom(e){return e?.offsetTop+e?.offsetHeight||void 0}getElementRootedBottom(e,t){return this.getElementRootedTop(e,t)+this.getElementHeight(e)}getElementRootedRealBottom(e,t){const o=this.create();e&&e.after(o);const i=e?this.getElementRootedTop(o,t):void 0;return o.remove(),i}getElementRootedRealTop(e,t){const o=parseInt(this.getComputedStyle(e).marginTop);return this.getElementRootedTop(e,t)-o}isLineChanged(e,t){return this.getElementRelativeTop(t)-this.getElementRelativeBottom(e)>-2}isLineKept(e,t){return this.getElementRelativeTop(t)-this.getElementRelativeBottom(e)<=-2}splitByLinesGreedy(e){return e.split(/(?<=\n)/)}splitByWordsGreedy(e){return e.innerHTML.split(/(?<=\s|-)/)}splitByWordsGreedyWithSpacesFilter(e){return e.innerHTML.trim().split(/(?<=\s|-)/).filter((e=>" "!=e))}prepareSplittedNode(e){const t=e,o=this.splitByWordsGreedy(e),i=o.map((e=>{const t=this.DOM.createElement("span");return t.innerHTML=e+" ",t})),n=this.createTestNodeFrom(e);return n.append(...i),e.append(n),{splittedNode:t,nodeWords:o,nodeWordItems:i}}createSignpost(e,t=24){const o=this.create();return o.style.display="flex",o.style.flexWrap="nowrap",o.style.alignItems="center",o.style.justifyContent="center",o.style.textAlign="center",o.style.fontSize="8px",o.style.fontFamily="sans-serif",o.style.letterSpacing="1px",o.style.textTransform="uppercase",o.style.height=t+"px",e&&(o.innerHTML=e),o}createTable({wrapper:e,caption:t,thead:o,tfoot:i,tbody:n}){const r=e||this.create("table"),s=this.create("TBODY");return t&&r.append(t),o&&r.append(o),n&&s.append(...n),r.append(s),i&&r.append(i),r}getTableEntries(e){const t=[...e.children].reduce((function(e,t){const o=t.tagName;return"TBODY"===o?{...e,rows:[...e.rows,...t.children]}:"CAPTION"===o?{...e,caption:t}:"COLGROUP"===o?{...e,colgroup:t}:"THEAD"===o?{...e,thead:t}:"TFOOT"===o?{...e,tfoot:t}:"TR"===o?{...e,rows:[...e.rows,...t]}:{...e,unexpected:[...e.unexpected,...t]}}),{caption:null,thead:null,tfoot:null,rows:[],unexpected:[]});return t.unexpected.length>0&&this.debugMode&&this.debugToggler._DOM&&console.warn(`something unexpected is found in the table ${e}`),t}lockTableWidths(e){this.copyNodeWidth(e,e),e.querySelectorAll("td").forEach((e=>this.copyNodeWidth(e,e)))}copyNodeWidth(e,t){e.style.width=this.getElementWidth(t)-1+"px"}findDeepestChild(e){let t=e;for(;t.firstElementChild;)t=t.firstElementChild;return t}}class o{constructor(e){this.config=e,this.charWidth="10px"}create(){return this._baseStyle()+this._testStyle()}_baseStyle(){return`\n\n@page {\n  size: A4;\n  /* 2 values: width then height */\n  size: ${this.config.printWidth} ${this.config.printHeight};\n\n  margin-left: ${this.config.printLeftMargin};\n  margin-right: ${this.config.printRightMargin};\n  margin-top: ${this.config.printTopMargin};\n  margin-bottom: 0; /* hack */\n}\n\n${e.root} {\n  /* reset user styles */\n  display: block;\n\n  /* for proper printable flow positioning */\n  position: relative;\n\n  /* to compensate for possible BG in the parent node */\n  z-index: 1;\n\n  /* set print styles: affects previews */\n  margin: 0 auto;\n  width: calc(${this.config.printWidth} - ${this.config.printLeftMargin} - ${this.config.printRightMargin});\n  font-size: ${this.config.printFontSize};\n\n  /* protection against unpredictability of margins */\n  padding-top: .1px;\n  padding-bottom: calc(2 * ${this.config.virtualPagesGap});\n}\n\n${e.pageDivider} {\n  display: block;\n}\n\n${e.virtualPaper} {\n  display: grid;\n  grid-template-columns: 1fr;\n  grid-template-rows: minmax(min-content, max-content) minmax(min-content, max-content) 1fr minmax(min-content, max-content) minmax(min-content, max-content);\n  place-items: stretch stretch;\n  place-content: stretch stretch;\n  width: calc(${this.config.printWidth} - ${this.config.printLeftMargin} - ${this.config.printRightMargin});\n  height: ${this.config.printHeight};\n  font-size: ${this.config.printFontSize};\n}\n\n${e.virtualPaper}::before {\n  position: absolute;\n  content: '';\n  width: ${this.config.printWidth};\n  height: ${this.config.printHeight};\n  left: -${this.config.printLeftMargin};\n  background-color: #fff;\n  box-shadow: rgba(0, 0, 0, 0.1) 2px 2px 12px 0px;\n  z-index: -1;\n}\n\n${e.paperFooter},\n${e.paperHeader} {\n  display: block;\n  position: relative;\n}\n\n${e.headerContent},\n${e.footerContent} {\n  display: block;\n  font-size: small;\n}\n\n${e.headerContent} p,\n${e.footerContent} p {\n  margin: 0;\n}\n\n${e.headerContent} {\n  padding-bottom: ${this.config.headerMargin};\n  /* padding-top: 1px; */\n  /* Page numbers: */\n  padding-top: 10px;\n}\n\n${e.footerContent} {\n  padding-top: ${this.config.footerMargin};\n  /* padding-bottom: 1px; */\n  /* Page numbers: */\n  min-height: 32px;\n}\n\n${e.tocPageNumber} {\n  min-width: 3ch;\n  display: flex;\n  justify-content: flex-end;\n  align-items: baseline;\n}\n\n${e.pageNumberRoot} {\n  display: flex;\n  column-gap: 2px;\n  position: absolute;\n  /* left: 100%; */\n  right: 0;\n  text-align: right;\n  line-height: 1;\n}\n\n${e.headerContent} ${e.pageNumberRoot} {\n  top: 0;\n}\n\n${e.footerContent} ${e.pageNumberRoot} {\n  bottom: 0;\n}\n\n${e.paperFlow} {\n  display: block;\n  position: absolute;\n  width: 100%;\n  z-index: -1;\n  /* affect only screen */\n  padding-bottom: 100px;\n}\n\n${e.contentFlow} {\n  display: block;\n}\n\n${e.runningSafety} {\n  display: block;\n  /* firefox ignores 0.1px size, so it's necessary to make a full-size pixel\n     and take it into account in the calculations\n  */\n  padding-top: 1px;\n}\n\n${e.virtualPaperTopMargin} {\n  display: block;\n  height: ${this.config.printTopMargin};\n}\n\n${e.virtualPaperBottomMargin} {\n  display: block;\n  height: ${this.config.printBottomMargin};\n}\n\n${e.virtualPaperGap} {\n  display: block;\n  padding-top: ${this.config.virtualPagesGap};\n}\n\n${e.paperBody} {\n  display: block;\n}\n\n${e.frontpageContent} {\n  display: block;\n  transform-origin: top center;\n  padding: .1px;\n  height: 100%;\n}\n\n.null {\n  display: inline;\n  padding: 0;\n  margin: 0;\n  font: 0;\n  color: transparent;\n  line-height: 0;\n  border: none;\n  outline: none;\n  background: none;\n  background-color: transparent;\n}\n\n${e.textNode},\n${e.neutral},\n${e.neutral} span {\n  display: inline;\n  padding: 0;\n  margin: 0;\n  font: inherit;\n  color: inherit;\n  line-height: inherit;\n  background: none;\n  background-color: transparent;\n}\n\n${e.complexTextBlock} {\n  display: block;\n}\n\n${e.printPageBreak} {\n  display: block;\n}\n\n${e.printForcedPageBreak} {\n  display: block;\n  visibility: hidden;\n  height: 0;\n  overflow: hidden;\n}\n\n@media print {\n  ${e.root} {\n    /* to prevent a blank last page */\n    padding: 0;\n  }\n\n  ${e.paperFlow} {\n    padding-bottom: 0;\n  }\n\n  ${e.contentFlow} {\n    -webkit-mask-image: none !important;\n            mask-image: none !important;\n  }\n\n  ${e.printIgnore} {\n    display: contents;\n  }\n\n  ${e.printHide},\n  ${e.virtualPaper}::before,\n  ${e.virtualPaperTopMargin},\n  ${e.virtualPaperBottomMargin},\n  ${e.virtualPaperGap} {\n    display: none;\n  }\n\n  ${e.virtualPaper} {\n    break-inside: avoid;\n    height: auto;\n  }\n\n  ${e.paperBody} {\n    break-inside: avoid;\n  }\n\n  ${e.printPageBreak} {\n    break-after: page;\n    padding: .1px;\n  }\n\n  ${e.printForcedPageBreak} {\n    /* JUST MANUAL! */\n    /* break-after: page; */\n  }\n\n  ${e.flagNoBreak} {\n    /*\n    TODO: temporary commented!\n    When splitting blocks, printPageBreak falls INTO this element,\n    and in Firefox it causes a blank page.\n    FIX the split of complex blocks and check in Firefox.\n    */\n    /* break-inside: avoid-page; */\n  }\n}\n\n/* arrangement */\n${e.topCutPart} {\n  margin-top: 0 !important;\n  border-top: none !important;\n}\n${e.bottomCutPart} {\n  margin-bottom: 0 !important;\n  border-bottom: none !important;\n}\n    `}_testStyle(){return this.config.debugMode?`\n/* FOR TEST */\n${e.virtualPaperGap} {\n  background: #ff000020;\n}\n\n${e.paperFooter},\n${e.paperHeader} {\n  background: #fa96ff20;\n}\n${e.paperBody} {\n  background: #ffee0020;\n}\n${e.runningSafety} {\n  background: #f200ff;\n}\n${e.frontpageContent} {\n  background: #00fcff20;\n}\n\n${e.neutral} {\n  background: #00ffee10;\n}\n\n${e.textNode} {\n  background: #00ff0010;\n}\n\n[filler] {\n  background:repeating-linear-gradient(\n    -45deg,\n    rgba(0, 175, 255, .1),\n    rgba(0, 175, 255, .1) 10px,\n    rgba(0, 175, 255, .15) 10px,\n    rgba(0, 175, 255, .15) 20px\n  );\n}\n    `:""}}const i="border:1px solid #8888CC;background:#EEEEEE;color:#8888CC;";class n{constructor({config:e,DOM:t,selector:o}){this.success=!1,this.root,this.paperFlow,this.contentFlow,this.frontpageTemplate,this.headerTemplate,this.footerTemplate,this._initialRoot,this._config=e,this._debugMode=e.debugMode,this._DOM=t,this._selector=o,this._customInitialRootSelector=e.initialRoot,this._defaultInitialRootSelector=o.init}create(){if(this._debugMode&&console.group("%c Layout ",i),this._getTemplates(),this._insertStyle(),this._DOM.getElement(`style${this._selector.style}`)){if(this._createLayout(),this._DOM.getParentNode(this.root)!==this._initialRoot||this._DOM.getElementOffsetParent(this.paperFlow)!==this.root||this._DOM.getElementOffsetParent(this.contentFlow)!==this.root)return console.assert(this._DOM.getParentNode(this.root)===this._initialRoot,"Failed to insert the layout root into the DOM."),console.assert(this._DOM.getElementOffsetParent(this.paperFlow)===this.root,"Failed to insert the paperFlow element into the DOM."),void console.assert(this._DOM.getElementOffsetParent(this.contentFlow)===this.root,"Failed to insert the contentFlow element into the DOM.");this.success=!0,this._debugMode&&console.groupEnd()}else console.error("Failed to add print styles into the DOM.")}_getTemplates(){console.assert(this._selector.frontpageTemplate,"frontpageTemplate selector is missing"),console.assert(this._selector.headerTemplate,"headerTemplate selector is missing"),console.assert(this._selector.footerTemplate,"footerTemplate selector is missing"),this.frontpageTemplate=this._DOM.getInnerHTML(this._selector.frontpageTemplate),this.headerTemplate=this._DOM.getInnerHTML(this._selector.headerTemplate),this.footerTemplate=this._DOM.getInnerHTML(this._selector.footerTemplate)}_insertStyle(){const e=this._DOM.getElement("head"),t=this._DOM.body;if(!e&&!t)return void console.error("Check the structure of your document. We didn`t find HEAD and BODY tags. HTML2PDF4DOC expects valid HTML.");const i=this._DOM.create("style",new o(this._config).create());i?(this._DOM.setAttribute(i,this._selector.style,""),e?this._DOM.insertAtEnd(e,i):t?this._DOM.insertBefore(t,i):console.assert(!1,"We expected to find the HEAD and BODY tags.")):console.error("Failed to create print styles")}_createLayout(){const e=this._getInitialRoot();if(!this._initialRoot)return void console.error("Failed to initialize the root element.");this._debugMode&&console.log("%c initial root ",i,this._initialRoot);const t=this._createRoot(),o=this._createPaperFlow(),n=this._createContentFlow(),r=this._DOM.getInnerHTML(e);r.trim().length>0?(this._DOM.setInnerHTML(n,r),this._DOM.insertAtEnd(n,this._DOM.create("[data-content-flow-end]"))):console.warn("It looks like you don't have any printable content."),this._DOM.setInnerHTML(e,""),this._DOM.insertAtEnd(e,t),this._DOM.insertAtEnd(t,o,n),this._ignoreUnprintableEnvironment(t)}_getInitialRoot(){let e=this._customInitialRootSelector?this._DOM.getElement(this._customInitialRootSelector):this._DOM.getElement(this._defaultInitialRootSelector);if(!e){if(!this._DOM.body)return void console.error("We expected to find the BODY tag.");e=this._DOM.body,console.warn(`The printable area is currently unspecified and encompasses the entire contents of the BODY tag. To restrict the printed content to a specific area, include ${this._defaultInitialRootSelector} in the root element of the desired printing area.`)}return this._initialRoot=e,e}_createRoot(){const e=this._DOM.create(this._selector.root);return this.root=e,e}_createPaperFlow(){const e=this._DOM.create(this._selector.paperFlow);return this.paperFlow=e,e}_createContentFlow(){const e=this._DOM.create(this._selector.contentFlow);return this.contentFlow=e,e}_ignoreUnprintableEnvironment(e){if(e===this._DOM.body)return void console.assert(!1,"misshapen root");let t=this._DOM.getParentNode(e);this._DOM.setAttribute(t,this._selector.printIgnore),this._DOM.getChildNodes(t).forEach((t=>{if(t!==e&&this._DOM.isElementNode(t))this._DOM.setAttribute(t,this._selector.printHide);else{if(!this._DOM.isSignificantTextNode(t))return;this._DOM.setAttribute(this._DOM.wrapTextNode(t),this._selector.printHide)}})),this._DOM.isDocumentBody(t)||this._ignoreUnprintableEnvironment(t)}}class r{constructor({config:e,DOM:t,selector:o}){this._config=e}init(){this._config.debugMode&&console.log("🍄 i am Node!")}}const s="#66CC00",l=`color: ${s};font-weight:bold`,a=`border:1px solid ${s};background:#EEEEEE;color:${s};`;class g{constructor({config:e,DOM:t,node:o,selector:i,layout:n,referenceWidth:r,referenceHeight:s}){this.debugMode=e.debugMode,this.debugToggler={_parseNode:!1,_parseNodes:!1,_registerPageStart:!1,_getProcessedChildren:!1,_splitPreNode:!1,_splitTableNode:!1,_splitTableRow:!1,_splitGridNode:!1,_createSlicesBySplitFlag:!1,_getInternalSplitters:!1,_splitComplexTextBlockIntoLines:!1},this.selector=i,this.node=o,this.noHangingSelectors=this._prepareNoHangingSelector(e.noHangingSelectors),this.pageBreakBeforeSelectors=this._arrayFromString(e.pageBreakBeforeSelectors),this.pageBreakAfterSelectors=this._arrayFromString(e.pageBreakAfterSelectors),this.forcedPageBreakSelectors=this._prepareForcedPageBreakSelector(e.forcedPageBreakSelectors),this.noBreakSelectors=this._arrayFromString(e.noBreakSelectors),this.DOM=t,this.root=n.root,this.contentFlow=n.contentFlow,this.referenceWidth=r,this.referenceHeight=s,this.minLeftLines=2,this.minDanglingLines=2,this.minBreakableLines=this.minLeftLines+this.minDanglingLines,this.minLeftRows=2,this.minDanglingRows=2,this.minBreakableRows=this.minLeftRows+this.minDanglingRows,this.minPreFirstBlockLines=3,this.minPreLastBlockLines=3,this.minPreBreakableLines=this.minPreFirstBlockLines+this.minPreLastBlockLines,this.minBreakableGridRows=4,this.imageReductionRatio=.8,this.signpostHeight=24,this.pages=[],this.commonLineHeight=this.DOM.getLineHeight(this.root),this.minimumBreakableHeight=this.commonLineHeight*this.minBreakableLines,this.isFirefox="undefined"!=typeof InstallTrigger}calculate(){return this.node.init(),this._prepareForcedPageBreakElements(),this._prepareNoBreakElements(),this._prepareNoHangingElements(),this._calculate(),this.debugMode&&console.log("%c ✔ Pages.calculate()",a,this.pages),this.pages}_prepareNoHangingElements(){this.noHangingSelectors&&this.DOM.findAllSelectorsInside(this.contentFlow,this.noHangingSelectors).forEach((e=>{this.DOM.setFlagNoHanging(e);const t=this.DOM.findLastChildParent(e,this.contentFlow);t&&this.DOM.setFlagNoHanging(t)}))}_prepareNoBreakElements(){this.noBreakSelectors&&this.DOM.findAllSelectorsInside(this.contentFlow,this.noBreakSelectors).forEach((e=>this.DOM.setFlagNoBreak(e)))}_prepareForcedPageBreakElements(){const e=this.pageBreakBeforeSelectors?this.DOM.findAllSelectorsInside(this.contentFlow,this.pageBreakBeforeSelectors):[],t=this.pageBreakAfterSelectors?this.DOM.findAllSelectorsInside(this.contentFlow,this.pageBreakAfterSelectors):[],o=this.DOM.findAllSelectorsInside(this.contentFlow,this.forcedPageBreakSelectors);this.DOM.isFirstChildOfFirstChild(e[0],this.contentFlow)&&e.shift(),this.DOM.isLastChildOfLastChild(t.at(-1),this.contentFlow)&&t.pop(),e.length&&e.forEach((e=>{const t=this.DOM.findFirstChildParent(e,this.contentFlow);t&&(e=t),this.DOM.insertForcedPageBreakBefore(e)})),o&&o.forEach((e=>{const t=this.DOM.findFirstChildParent(e,this.contentFlow);t&&(e=t),this.DOM.insertForcedPageBreakBefore(e)})),t.length&&t.forEach((e=>{const t=this.DOM.findLastChildParent(e,this.contentFlow);t&&(e=t),this.DOM.isForcedPageBreak(e.nextElementSibling)||this.DOM.insertForcedPageBreakAfter(e)}))}_calculate(){if(this.debugMode&&console.log("%c ▼▼▼ Pages ▼▼▼ ",a),this.debugMode&&console.groupCollapsed("•• init data ••"),this.debugMode&&console.log("this.referenceHeight",this.referenceHeight,"\n","this.noHangingSelectors",this.noHangingSelectors,"\n","this.pageBreakBeforeSelectors",this.pageBreakBeforeSelectors,"\n","this.pageBreakAfterSelectors",this.pageBreakAfterSelectors,"\n","this.forcedPageBreakSelectors",this.forcedPageBreakSelectors,"\n","this.noBreakSelectors",this.noBreakSelectors,"\n","isFirefox",this.isFirefox),this.debugMode&&console.groupEnd(),this.DOM.getElementRootedRealBottom(this.contentFlow,this.root)<this.referenceHeight){const e=this.DOM.create("[data-content-flow-start]");return this.DOM.insertAtStart(this.contentFlow,e),this._registerPageStart(e),void this.DOM.findAllForcedPageBreakInside(this.contentFlow).forEach((e=>this._registerPageStart(e)))}const e=this._getChildren(this.contentFlow);this.debugMode&&console.groupCollapsed("%c🚸 children(contentFlow)",a),this.debugMode&&console.log(e),this.debugMode&&console.groupEnd(),this._registerPageStart(e[0]),this._parseNodes({array:e})}_registerPageStart(e,t=!1){t&&(e=this.DOM.findFirstChildParent(e,this.contentFlow)||e,e=this.DOM.findPreviousNoHangingsFromPage(e,this.DOM.getElementRootedTop(this.pages.at(-1)?.pageStart,this.root),this.root)||e);const o=this.DOM.getElementRootedRealTop(e,this.root)+this.referenceHeight;this.pages.push({pageStart:e,pageBottom:o}),this.DOM.markPageStartElement(e,this.pages.length),this.debugMode&&this.debugToggler._registerPageStart&&console.log(`📍 %c register page ${this.pages.length} \n`,"background:yellow; color:red",o,e)}_parseNodes({array:e,previous:t,next:o,parent:i,parentBottom:n}){this.debugMode&&this.debugToggler._parseNodes&&console.log("🔵 _parseNodes","\narray:",[...e],"\ntracedParent:",i);for(let r=0;r<e.length;r++)this._parseNode({previousElement:e[r-1]||t,currentElement:e[r],nextElement:e[r+1]||o,isCurrentFirst:0==r&&!e[r-1],parent:i,parentBottom:r===e.length-1?n:void 0})}_parseNode({isCurrentFirst:e,previousElement:t,currentElement:o,nextElement:i,parent:n,parentBottom:r}){const s=["%c_parseNode\n","color:white"];this.debugMode&&this.debugToggler._parseNode&&console.group("%c_parseNode",l,r?"★last★":""),this.debugMode&&this.debugToggler._parseNode&&console.log(...s,"3 nodes: ",{previousElement:t,currentElement:o,nextElement:i},"\n","\ncurrent: ",o,"\nparent: ",n,"\nisCurrentFirst: ",e);const a=e&&n?n:o;if(this.debugMode&&this.debugToggler._parseNode&&console.log(...s,"parent:",n,"\n","parentBottom:",r,"\n","currentOrParentElement:",a,"\n"),!i)return void(this.debugMode&&this.debugToggler._parseNode&&console.groupEnd());if(this.DOM.isForcedPageBreak(o))return this._registerPageStart(o),void(this.debugMode&&this.debugToggler._parseNode&&console.groupEnd());this.debugMode&&console.assert(this.DOM.getElementOffsetParent(o),"it is expected that the element has an offset parent",o);const g=this.pages.at(-1).pageBottom,h=this.DOM.getElementRootedTop(i,this.root);if(this.debugMode&&this.debugToggler._parseNode&&console.log(...s,"• newPageBottom",g,"\n","• nextElementTop",h),h<=g)this.debugMode&&this.debugToggler._parseNode&&console.log("nextElementTop <= newPageBottom",h,"<=",g),this.DOM.findAllForcedPageBreakInside(o).forEach((e=>this._registerPageStart(e)));else{if(this.debugMode&&this.debugToggler._parseNode&&console.log("nextElementTop > newPageBottom",h,">",g),this._isNoHanging(o))return this.debugMode&&this.debugToggler._parseNode&&console.log("currentElement _isNoHanging => move it to the next page"),this._registerPageStart(o,!0),void(this.debugMode&&this.debugToggler._parseNode&&console.groupEnd());if(this._isSVG(o)||this._isIMG(o)){const e=this._isSVG(o)?this.DOM.wrapWithFlagNoBreak(o):o,t=g-this.DOM.getElementRootedTop(e,this.root),n=this.DOM.getElementHeight(e),r=this.DOM.getElementWidth(e);return n<this.referenceWidth&&this.debugMode&&this.debugToggler._parseNode&&console.warn("%c IMAGE is too wide","color: red"),n<t?(this._registerPageStart(i),void(this.debugMode&&this.debugToggler._parseNode&&console.groupEnd())):t/n>this.imageReductionRatio?(this._registerPageStart(i),this.DOM.fitElementWithinBoundaries({element:o,height:n,width:r,vspace:t,hspace:this.referenceWidth}),void(this.debugMode&&this.debugToggler._parseNode&&console.groupEnd())):(this._registerPageStart(e,!0),n>this.referenceHeight&&this.DOM.fitElementWithinBoundaries({element:o,height:n,width:r,vspace:this.referenceHeight,hspace:this.referenceWidth}),void(this.debugMode&&this.debugToggler._parseNode&&console.groupEnd()))}if(o.style.height){this.debugMode&&this.debugToggler._parseNode&&console.log("🥁 currentElement has HEIGHT",o.style.height);const e=this.DOM.getElementRootedTop(o,this.root),t=g-e,n=h-e,r=t/n,s=this.referenceHeight/n;return this.debugMode&&this.debugToggler._parseNode&&console.log("\n🥁 currentElementTop",e,"\n🥁 availableSpace",t,"\n🥁 currentElementContextualHeight",n,"\n🥁 availableSpaceFactor",r,"\n🥁 fullPageFactor",s),console.assert(r<1),r>.8?(this.debugMode&&this.debugToggler._parseNode&&console.log("🥁 availableSpaceFactor > 0.8: ",r),this.DOM.setStyles(o,{transform:`scale(${r})`}),this._registerPageStart(i),void(this.debugMode&&this.debugToggler._parseNode&&console.groupEnd())):(s<1&&(this.debugMode&&this.debugToggler._parseNode&&console.log("🥁 fullPageFactor < 1: ",s),this.DOM.setStyles(o,{transform:`scale(${s})`})),this.debugMode&&this.debugToggler._parseNode&&console.log("🥁 _registerPageStart",o),this._registerPageStart(o),void(this.debugMode&&this.debugToggler._parseNode&&console.groupEnd()))}const l=r||this.DOM.getElementRootedRealBottom(o,this.root);if(this.debugMode&&this.debugToggler._parseNode&&console.log("split or not? \n","currentElementBottom",l),l<=g)return this.debugMode&&this.debugToggler._parseNode&&console.log("currentElementBottom <= newPageBottom",l,"<=",g,"\n register nextElement as pageStart"),this._registerPageStart(i),void(this.debugMode&&this.debugToggler._parseNode&&console.groupEnd());if(this.debugMode&&this.debugToggler._parseNode&&console.log("currentElementBottom > newPageBottom",l,">",g),this.DOM.getElementHeight(o)+2<this.minimumBreakableHeight)return this.debugMode&&this.debugToggler._parseNode&&console.log("this.DOM.getElementHeight(currentElement) + 2 < this.minimumBreakableHeight",this.DOM.getElementHeight(o)),this._registerPageStart(o,!0),void(this.debugMode&&this.debugToggler._parseNode&&console.groupEnd());const d=this._getProcessedChildren(o,g,this.referenceHeight);this.debugMode&&this.debugToggler._parseNode&&console.log("try to break it and loop the children:",d);const c=d.length;this.debugMode&&this.debugToggler._parseNode&&console.log(...s,"childrenNumber ",c),this.debugMode&&this.debugToggler._parseNode&&console.log(...s,"currentElement ",o);const p=e&&n||o;if(c){const e=this._isFullySPlitted(o);this._parseNodes({array:d,previous:t,next:i,parent:p,parentBottom:e?void 0:l})}else this._isNoHanging(t)?this._registerPageStart(t,!0):(this.debugMode&&this.debugToggler._parseNode&&console.log(...s,"_registerPageStart (from _parseNode): \n",a),this._registerPageStart(o,!0))}this.debugMode&&this.debugToggler._parseNode&&console.groupEnd()}_isFullySPlitted(e){const t=this.DOM.getComputedStyle(e);return this._isPRE(e,t)||this._isTableNode(e,t)||this._isTableLikeNode(e,t)||this.DOM.isGridAutoFlowRow(t)}_getProcessedChildren(e,t,o){const i=["%c_getProcessedChildren\n","color:white"];let n=[];if(this._isNoBreak(e))return this.debugMode&&this.debugToggler._getProcessedChildren&&console.info(...i,"🧡 isNoBreak",e),[];if(this.DOM.isComplexTextBlock(e))return this.debugMode&&this.debugToggler._getProcessedChildren&&console.info(...i,"💚 ComplexTextBlock",e),this._splitComplexTextBlockIntoLines(e)||[];if(this._isTextNode(e))return this.debugMode&&this.debugToggler._getProcessedChildren&&console.info(...i,"💚 TextNode",e),this._splitComplexTextBlockIntoLines(e)||[];const r=this.DOM.getComputedStyle(e);return this._isTableLikeNode(e,r)?(this.debugMode&&this.debugToggler._getProcessedChildren&&console.info(...i,"💚 TABLE like",e),n=this._splitTableLikeNode(e,t,o,r)||[]):this._isTableNode(e,r)?(this.debugMode&&this.debugToggler._getProcessedChildren&&console.info(...i,"💚 TABLE",e),n=this._splitTableNode(e,t,o,r)||[]):this._isPRE(e,r)?(this.debugMode&&this.debugToggler._getProcessedChildren&&console.info(...i,"💚 PRE",e),n=this._splitPreNode(e,t,o)||[]):this.DOM.isGridAutoFlowRow(this.DOM.getComputedStyle(e))?(this.debugMode&&this.debugToggler._getProcessedChildren&&console.info(...i,"💜 GRID"),n=this._splitGridNode(e,t,o)||[]):(this.debugMode&&this.debugToggler._getProcessedChildren&&console.info(...i,"💚 some node",e),n=this._getChildren(e),this.debugMode&&this.debugToggler._getProcessedChildren&&console.info(...i,"🚸 get element children ",n)),n}_processInlineChildren(e){let t=null;const o=[];return e.forEach((e=>{this.DOM.isInline(this.DOM.getComputedStyle(e))?(t||(t=this.DOM.createComplexTextBlock(),this.DOM.wrapNode(e,t),o.push(t)),this.DOM.insertAtEnd(t,e)):(t=null,o.push(e))})),o}_splitComplexTextBlockIntoLines(e){if(this.debugMode&&this.debugToggler._splitComplexTextBlockIntoLines&&console.group("_splitComplexTextBlockIntoLines"),this.debugMode&&this.debugToggler._splitComplexTextBlockIntoLines&&console.log("_splitComplexTextBlockIntoLines (node)",e),this.DOM.isSelectorMatching(e,"[html2pdf-splitted]"))return this.debugMode&&this.debugToggler._splitComplexTextBlockIntoLines&&console.groupEnd(),this._getChildren(e);const t=this._getChildren(e).map((e=>{const t=this.DOM.getLineHeight(e);return{element:e,lines:~~(this.DOM.getElementHeight(e)/t),left:this.DOM.getElementLeft(e),top:this.DOM.getElementTop(e),lineHeight:t,text:e.innerHTML}})).flatMap((e=>e.lines>1&&!this._isNoBreak(e.element)?(e.element.classList.add("newComplexChildren🅱️"),this._breakItIntoLines(e.element)):e.element)).reduce(((e,t,o,i)=>"BR"===this.DOM.getElementTagName(t)?(e.at(-1).push(t),e.push([]),e):!e.length||this.DOM.isLineChanged(e.at(-1).at(-1),t)?(e.push([t]),e):0===e.at(-1).length||e.length&&this.DOM.isLineKept(e.at(-1).at(-1),t)?(e.at(-1).push(t),e):void(this.debugMode&&console.assert(!0,"newComplexChildrenGroups: An unexpected case of splitting a complex paragraph into lines.","\nOn the element:",t))),[]);if(this.debugMode&&this.debugToggler._splitComplexTextBlockIntoLines&&console.log("🟡🟡🟡 newComplexChildrenGroups",t),t.length<this.minBreakableLines)return this.debugMode&&this.debugToggler._splitComplexTextBlockIntoLines&&console.log("newComplexChildrenGroups.length < this.minBreakableLines",t.length,"<",this.minBreakableLines),this.debugMode&&this.debugToggler._splitComplexTextBlockIntoLines&&console.groupEnd(),[];const o=t.slice(0,this.minLeftLines).flat(),i=t.slice(-this.minDanglingLines).flat();t.splice(0,this.minLeftLines,o),t.splice(-this.minDanglingLines,this.minDanglingLines,i);const n=t.map(((e,t)=>{const o=this.DOM.createWithFlagNoBreak();return e.length>1&&o.classList.add("group🛗"),o.setAttribute("role","group〰️"),0==e.length?(o.setAttribute("role","🚫"),console.assert(0==e.length,"The string cannot be empty (_splitComplexTextBlockIntoLines)")):1==e.length?o.setAttribute("role","line"):o.setAttribute("role","group"),o.dataset.index=t,this.DOM.insertBefore(e[0],o),this.DOM.insertAtEnd(o,...e),o}));return this.debugMode&&this.debugToggler._splitComplexTextBlockIntoLines&&console.groupEnd(),this.DOM.setAttribute(e,"[html2pdf-splitted]"),n}_breakItIntoLines(e){if(this._isNoBreak(e))return e;const t=this.DOM.splitByWordsGreedyWithSpacesFilter(e),o=t.map(((e,t)=>{const o=this.DOM.create("html2pdf-word");return o.dataset.index=t,o.innerHTML=e+"",o}));e.innerHTML="",this.DOM.insertAtEnd(e,...o);const i=o.reduce(((e,t,i)=>(i>0&&o[i-1].offsetTop+o[i-1].offsetHeight<=t.offsetTop&&e.push(i),e)),[0]),n=i.reduce(((o,n,r)=>{const s=this.DOM.cloneNodeWrapper(e);this.DOM.setFlagNoBreak(s),s.setAttribute("role","line-simplest"),s.classList.add("cloned🅱️");const l=i[r],a=i[r+1],g=" "+t.slice(l,a).join("")+" ";return this.DOM.setInnerHTML(s,g),this.DOM.insertBefore(e,s),r>0&&s.removeAttribute("id"),o.push(s),o}),[]);return e.remove(),n}_isVerticalFlowDisrupted(e){return e.some(((e,t,o)=>{const i=e,n=o[t+1];return!!n&&this.DOM.getElementRelativeBottom(i)>this.DOM.getElementRelativeTop(n)}))}_splitPreNode(e,t,o,i){const n=i||this.DOM.getComputedStyle(e),r=["%c_splitPreNode\n","color:white"];this.debugMode&&this.debugToggler._splitPreNode&&console.group("%c_splitPreNode","background:cyan"),this.debugMode&&this.debugToggler._splitPreNode&&console.log(...r,"node",e);const s=this.DOM.getElementRootedTop(e,this.root),l=this.DOM.getElementHeight(e),a=this.DOM.getLineHeight(e),g=this.DOM.getEmptyNodeHeight(e,!1);if(l<g+a*this.minPreBreakableLines)return[];const h=this.DOM.getChildNodes(e);if(this.debugMode&&this.debugToggler._splitPreNode&&console.log("_children:",h.length),0==h.length)return[];if(h.length>1)return[];{if(this.DOM.isElementNode(h[0])){const e=h[0];return this.debugMode&&this.debugToggler._splitPreNode&&console.warn("is Element Node",e),[]}this.DOM.isTextNode(h[0])&&this.debugMode&&this.debugToggler._splitPreNode&&console.warn(`is TEXT Node: ${h[0]}`);const i=h[0].wholeText,l=this.DOM.splitByLinesGreedy(i);if(l.length<this.minPreBreakableLines)return[];const a=l.splice(0,this.minPreFirstBlockLines).join(""),d=l.splice(-this.minPreLastBlockLines).join("");l.unshift(a),l.push(d);const c=l.map((e=>{const t=this.DOM.createWithFlagNoBreak();return this.DOM.setInnerHTML(t,e),t}));this.debugMode&&this.debugToggler._splitPreNode&&console.log("linesFromNode",c),this.DOM.replaceNodeContentsWith(e,...c);const p=o-g;let u=0,m=[],b=t-s-g;const M=n.position;"relative"!=M&&(e.style.position="relative");for(let t=0;t<c.length;t++){const o=c[t];this.DOM.getElementRootedBottom(o,e)>b&&(t&&m.push(t),t&&(u+=1),b=t?this.DOM.getElementRootedTop(o,e)+p:p)}if(e.style.position=M,!m.length)return[];m.push(null),this.debugMode&&this.debugToggler._splitPreNode&&console.log(...r,"splitters",m);const f=m.map(((t,o,i)=>{const n=this.DOM.cloneNodeWrapper(e);this.DOM.setFlagNoBreak(n);const r=i[o-1]||0,s=t||i[i.length];return this.DOM.insertAtEnd(n,...c.slice(r,s)),n}));return this.DOM.markPartNodesWithClass(f),this.debugMode&&this.debugToggler._splitPreNode&&console.log(...r,"newPreElementsArray",f),this.DOM.replaceNodeContentsWith(e,...f),e.style.display="contents",e.setAttribute("slough-node",""),e.classList="",this.debugMode&&this.debugToggler._splitPreNode&&console.groupEnd(),f}}_insertTableSplit({startId:e,endId:t,table:o,tableEntries:i}){const n=this.DOM.cloneNodeWrapper(o),r=i.rows.slice(e,t),s=this.DOM.createWithFlagNoBreak();return o.before(s),e&&this.DOM.insertAtEnd(s,this.DOM.createSignpost("(table continued)",this.signpostHeight)),this.DOM.insertAtEnd(s,this.DOM.createTable({wrapper:n,caption:this.DOM.cloneNode(i.caption),thead:this.DOM.cloneNode(i.thead),tbody:r}),this.DOM.createSignpost("(table continues on the next page)",this.signpostHeight)),s}_splitTableLikeNode(e,t,o,i){const n=i||this.DOM.getComputedStyle(e),r=this._getChildren(e),s=this.DOM.getElementRootedTop(e,this.root),l=this.DOM.getEmptyNodeHeight(e),a=o-l;let g=r,h=0,d=[],c=t-s-l;const p=n.position;"relative"!=p&&(e.style.position="relative");for(let t=0;t<g.length;t++){const o=g[t];this.DOM.getElementRootedBottom(o,e)>c&&(t&&d.push(t),t&&(h+=1),c=t?this.DOM.getElementRootedTop(o,e)+a:a)}if(e.style.position=p,!d.length)return console.log("splitters.length",d.length),[];d.push(null);const u=d.map(((t,o,i)=>{const n=this.DOM.cloneNodeWrapper(e);this.DOM.setFlagNoBreak(n),this.DOM.unmarkPageStartElement(n);const r=i[o-1]||0,s=t||i[i.length];return this.DOM.insertAtEnd(n,...g.slice(r,s)),n}));return this.DOM.markPartNodesWithClass(u),this.DOM.replaceNodeContentsWith(e,...u),this.DOM.removeAllClasses(e),this.DOM.removeAllStyles(e),e.style.display="contents",this.DOM.setAttribute(e,"slough-node",""),u}_splitTableNode(e,t,o){this.DOM.lockTableWidths(e);const i=["%c_splitTableNode\n","color:white"];this.debugMode&&this.debugToggler._splitTableNode&&console.time("_splitTableNode"),this.debugMode&&this.debugToggler._splitTableNode&&console.group("%c_splitTableNode","background:cyan"),this.debugMode&&this.debugToggler._splitTableNode&&console.log(...i,"table",e);const n=this.DOM.getEmptyNodeHeight(e),r=this.DOM.getTableEntries(e);if(this.debugMode&&this.debugToggler._splitTableNode&&console.log(...i,"tableEntries",r),r.rows.length<this.minBreakableRows)return this.debugMode&&this.debugToggler._splitTableNode&&console.groupEnd(),[];const s=this.DOM.getElementRootedTop(e,this.root),l=(this.DOM.getElementHeight(e),this.DOM.getElementHeight(r.caption)||0),a=this.DOM.getElementHeight(r.thead)||0,g=this.DOM.getElementHeight(r.tfoot)||0,h=(l??0)*(this.isFirefox??0),d=t-s-this.signpostHeight-n,c=o-l-a-g-2*this.signpostHeight-n;this.debugMode&&this.debugToggler._splitTableNode&&console.log(...i,"pageBottom",t,"\n","- tableTop",s,"\n","- tableWrapperHeight",n,"\n","- this.signpostHeight",this.signpostHeight,"\n","= firstPartHeight",d),this.debugMode&&this.debugToggler._splitTableNode&&console.log(...i,"fullPageHeight",o,"\n","- tableCaptionHeight",l,"\n","- tableTheadHeight",a,"\n","- tableTfootHeight",g,"\n","- 2 * this.signpostHeight",2*this.signpostHeight,"\n","- tableWrapperHeight",n,"\n","= fullPagePartHeight",c);const p=e=>[...e.rows,e.tfoot||[]];let u=p(r),m=[],b=d;for(let o=0;o<u.length;o++){const i=u[o];if(this.DOM.getElementRootedTop(i,e)+h>b)if(0===o)b=c;else{const i=o-1,n=r.rows[i],s=this.DOM.getElementHeight(n),l=this.DOM.getTableRowHeight(n,this.minBreakableRows),a=this.DOM.getTableRowHeight(n),g=this.DOM.getElementRootedTop(n,e)+h,M=this.DOM.isNoBreak(n);if(s>=l&&!M){this.debugMode&&this.debugToggler._splitTableRow&&console.group("🟣🟣🟣 Split The Row "+(o-1));const e=d-a-g,s=c-a,l=this.DOM.getChildren(n);let h;h=[...l].map((o=>{const i=this._getChildren(o);return this._getInternalSplitters({rootNode:o,children:i,pageBottom:t,firstPartHeight:e,fullPageHeight:s})})),this.debugMode&&this.debugToggler._splitTableRow&&console.log("🟣 \ntheRowContentSlicesByTD",h);const m=h.some((e=>(this.debugMode&&this.debugToggler._splitTableRow&&console.log("🟣","\nobj.result.length",e.result.length,"\nobj.result[0]",e.result[0]),e.result.length&&null===e.result[0])));this.debugMode&&this.debugToggler._splitTableRow&&console.log("🟣","\nshouldFirstPartBeSkipped",m),m&&(h=[...l].map((e=>{const o=this._getChildren(e);return this._getInternalSplitters({rootNode:e,children:o,pageBottom:t,firstPartHeight:s,fullPageHeight:s})}))),this.debugMode&&this.debugToggler._splitTableRow&&console.log("🟣","\n theRowContentSlicesByTD",h);const b=h.some((e=>e.result.length));if(this.debugMode&&this.debugToggler._splitTableRow&&console.log("🟣 ifThereIsSplit",b),b){const e=h.map((e=>{if(e.result.length)return this._createSlicesBySplitFlag(e.trail);{const t=this.DOM.createWithFlagNoBreak();t.classList.add("🟣"),t.display="contents";const o=e.trail.map((e=>e.element));return this.DOM.insertAtEnd(t,...o),[t]}}));this.debugMode&&this.debugToggler._splitTableRow&&console.log("🟣 theTdContentElements",e);const t=Math.max(...e.map((e=>e.length)));this.debugMode&&this.debugToggler._splitTableRow&&console.log("🟣 theNewTrCount",t);const s=[];for(let o=0;o<t;o++){const t=this.DOM.cloneNodeWrapper(n);this.DOM.setFlagNoBreak(t),[...l].forEach(((i,n)=>{const r=this.DOM.cloneNodeWrapper(i);e[n][o]&&this.DOM.insertAtEnd(r,e[n][o]),this.DOM.insertAtEnd(t,r)})),s.push(t)}this.debugMode&&this.debugToggler._splitTableRow&&console.log("🟣","\n theNewRows",s),n.className="splittingRow",this.debugMode&&this.debugToggler._splitTableRow&&console.log("🟣 splittingRow",n),this.DOM.insertInsteadOf(n,...s),r.rows.splice(i,1,...s),u=p(r),o-=1}this.debugMode&&this.debugToggler._splitTableRow&&console.groupEnd()}else o>this.minLeftRows&&m.push(o-1),b=this.DOM.getElementRootedTop(u[o-1],e)+h+c}}if(this.debugMode&&this.debugToggler._splitTableNode&&console.log(...i,"splitsIds",m),!m.length)return this.debugMode&&this.debugToggler._splitTableNode&&console.groupEnd(),[];const M=u.length-1-this.minDanglingRows;m[m.length-1]>M&&(m[m.length-1]=M);const f=m.map(((t,o,i)=>this._insertTableSplit({startId:i[o-1]||0,endId:t,table:e,tableEntries:r})));this.debugMode&&this.debugToggler._splitTableNode&&console.log(...i,"splits",f);const _=this.DOM.createWithFlagNoBreak();return e.before(_),this.DOM.insertAtEnd(_,this.DOM.createSignpost("(table continued)",this.signpostHeight),e),this.debugMode&&this.debugToggler._splitTableNode&&console.timeEnd("_splitTableNode"),this.debugMode&&this.debugToggler._splitTableNode&&console.groupEnd(),[...f,_]}_createSlicesBySplitFlag(e){const t=this.DOM.createWithFlagNoBreak();t.classList.add("🧰"),t.display="contents";const o=[t];let i=[t],n=t;const r=e=>{if(0===e.length)return null;const t=e[0];let o=t;for(let t=1;t<e.length;t++){const i=e[t];this.DOM.insertAtEnd(o,i),o=i}return this.debugMode&&this.debugToggler._createSlicesBySplitFlag&&console.log(" createWrapperFromArray:",t),t},s=(e,t=null)=>{this.debugMode&&this.debugToggler._createSlicesBySplitFlag&&console.group("processChildren"),this.debugMode&&this.debugToggler._createSlicesBySplitFlag&&console.log("*start* children",e);for(let t=0;t<e.length;t++)l(e[t]);this.debugMode&&this.debugToggler._createSlicesBySplitFlag&&console.log("- wrappers BEFORE pop:",[...i]);const o=i.pop();this.debugMode&&this.debugToggler._createSlicesBySplitFlag&&console.log("- wrappers.pop()",o),this.debugMode&&this.debugToggler._createSlicesBySplitFlag&&console.log("- parent",t),this.debugMode&&this.debugToggler._createSlicesBySplitFlag&&console.log("- wrappers AFTER pop:",[...i]),n=i.at(-1),this.debugMode&&this.debugToggler._createSlicesBySplitFlag&&console.log("🎯🎯 currentTargetInSlice",n),this.debugMode&&this.debugToggler._createSlicesBySplitFlag&&console.log("🎯 wrappers.at(-1)",i.at(-1)),this.debugMode&&this.debugToggler._createSlicesBySplitFlag&&console.log("*END* children",e),this.debugMode&&this.debugToggler._createSlicesBySplitFlag&&console.groupEnd()},l=e=>{const t=e.children?.length>0,l=e.split,a=e.element,g=e.id;if(this.debugMode&&this.debugToggler._createSlicesBySplitFlag&&console.group(`processObj # ${g}`),this.debugMode&&this.debugToggler._createSlicesBySplitFlag&&console.log("currentElement",a),a&&this.DOM.removeNode(a),l){this.debugMode&&this.debugToggler._createSlicesBySplitFlag&&console.log("••• hasSplitFlag"),i=i.map((e=>{const t=this.DOM.cloneNodeWrapper(e);return t.classList.add("🚩"),t})),this.debugMode&&this.debugToggler._createSlicesBySplitFlag&&console.log("• hasSplitFlag: NEW wrappers.map:",[...i]);const e=r(i);o.push(e),this.debugMode&&this.debugToggler._createSlicesBySplitFlag&&console.log("• hasSplitFlag: slices.push(nextWrapper):",[...o]),n=i.at(-1),this.debugMode&&this.debugToggler._createSlicesBySplitFlag&&console.log("• hasSplitFlag: currentTargetInSlice:",n)}if(t){this.debugMode&&this.debugToggler._createSlicesBySplitFlag&&console.log("••• hasChildren");const t=this.DOM.cloneNodeWrapper(a);i.push(t),this.debugMode&&this.debugToggler._createSlicesBySplitFlag&&console.log("• hasChildren: wrappers.push(cloneCurrentElementWrapper)",t,[...i]),this.debugMode&&this.debugToggler._createSlicesBySplitFlag&&console.log("• hasChildren: currentTargetInSlice (check):",n),n?(this.debugMode&&this.debugToggler._createSlicesBySplitFlag&&console.log("• hasChildren: currentTargetInSlice","TRUE, add to existing",t),this.DOM.insertAtEnd(n,t)):(this.debugMode&&this.debugToggler._createSlicesBySplitFlag&&console.log("• hasChildren: currentTargetInSlice","FALSE, init the first",t),t.classList.add("🏁first"),t.style.background="yellow",o.push(t),this.debugMode&&this.debugToggler._createSlicesBySplitFlag&&console.log("• hasChildren: slices.push(cloneCurrentElementWrapper)",t,[...o])),n=i.at(-1),this.debugMode&&this.debugToggler._createSlicesBySplitFlag&&console.log("• hasChildren:  currentTargetInSlice (=):",n),s(e.children,a)}else n=i.at(-1),this.debugMode&&this.debugToggler._createSlicesBySplitFlag&&console.log("insert currentElement",a,"to target",n),this.DOM.insertAtEnd(n,a);this.debugMode&&this.debugToggler._createSlicesBySplitFlag&&console.groupEnd()};return this.debugMode&&this.debugToggler._createSlicesBySplitFlag&&console.log("#######  currentTargetInSlice (=):",n),s(e),this.debugMode&&this.debugToggler._createSlicesBySplitFlag&&console.log("slices:",o),this.debugMode&&this.debugToggler._createSlicesBySplitFlag&&o.forEach((e=>console.log("slice:",e))),this.debugMode&&this.debugToggler._createSlicesBySplitFlag&&console.groupEnd(),o}_getInternalSplitters({rootNode:e,rootComputedStyle:t,children:o,pageBottom:i,firstPartHeight:n,fullPageHeight:r,result:s=[],trail:l=[],indexTracker:a=[],stack:g=[]}){const h=t||this.DOM.getComputedStyle(e),d=h.position;"relative"!=d&&(e.style.position="relative"),this.debugMode&&this.debugToggler._getInternalSplitters&&console.groupCollapsed("💟 _getInternalSplitters");const c=e=>{e>=0?a.push(e):a.pop()},p=(e,t)=>{this.debugMode&&this.debugToggler._getInternalSplitters&&console.assert(t>=0,"registerResult: ID mast be provided",e);let o,i=l[t];if(this.debugMode&&this.debugToggler._getInternalSplitters&&console.groupCollapsed("💜💜💜 registerResult(element, id)"),this.debugMode&&this.debugToggler._getInternalSplitters&&console.log("\n element",e,"\n id",t,"\n theElementObject (trail[id])",i,"\n theElementIndexInStack",o),0==t){const e=(e=>{let t,o=null;for(let i=e.length-1;i>=0;i--){if(0!==e[i].id)return{item:o,index:t};o=e[i],t=i}return{item:o,index:t}})(g);this.debugMode&&this.debugToggler._getInternalSplitters&&console.log("💜💜 id == 0","\n💜 [...stack]",[...g],"\n💜 topParentElementFromStack",e),e.item&&(i=e.item,o=e.index)}this.debugMode&&this.debugToggler._getInternalSplitters&&console.log("💜","\n theElementObject",i,"\n theElementIndexInStack",o,"\n [...indexTracker]",[...a]),0===o?(s.push(null),this.debugMode&&this.debugToggler._getInternalSplitters&&console.log("result.push(null)","\n\n💜💜💜")):(s.push(i.element),i&&(i.split=!0),this.debugMode&&this.debugToggler._getInternalSplitters&&console.log("\n theElementObject",i,"\n theElementObject.element",i.element,"\n result.push(theElementObject.element)","\n\n💜💜💜 ")),this.debugMode&&this.debugToggler._getInternalSplitters&&console.groupEnd()};this.debugMode&&this.debugToggler._getInternalSplitters&&console.log("💟 result 💟",s,"\n\n","\n rootNode:",e,"\n children:",o,"\n pageBottom:",i,"\n firstPartHeight:",n,"\n fullPageHeight:",r,"\n\n\n","💟 stack",[...g]);for(let t=0;t<o.length;t++){const d=o[t-1],u=o[t],m=o[t+1],b=m?this.DOM.getElementRootedTop(m,e):void 0,M={id:t,element:o[t]},f={id:t+1,element:o[t+1]};t!==(l.length?l.at(-1).id:void 0)&&l.push(M);const _=0===s.length?n:null===s.at(-1)?r:r+this.DOM.getElementRootedTop(s.at(-1),e);if(this.DOM.isForcedPageBreak(u)&&this.debugMode&&this.debugToggler._getInternalSplitters&&console.warn(u,"💟 is isForcedPageBreak"),b<=_)this._isNoHanging(u)&&(this.debugMode&&this.debugToggler._getInternalSplitters&&console.log("💟💟 currentElement _isNoHanging"),p(u,t));else{this.debugMode&&this.debugToggler._getInternalSplitters&&console.log("💟💟",`nextElementTop > floater \n ${b} > ${_} `),(this._isSVG(u)||this._isIMG(u))&&this.debugMode&&this.debugToggler._getInternalSplitters&&console.log("%cIMAGE 💟💟","color:red;text-weight:bold");const o=this.DOM.getElementRootedRealBottom(u,e);if(this.debugMode&&this.debugToggler._getInternalSplitters&&console.log("💟💟 current ???","\n currentElement",u,"\n currentElementBottom",o,"\n floater",_),o<=_)this.debugMode&&this.debugToggler._getInternalSplitters&&console.log("💟💟💟 currentElementBottom <= floater"),m&&(this.debugMode&&this.debugToggler._getInternalSplitters&&console.log("💟💟💟💟 register nextElement"),l.push(f),p(m,t+1));else{this.debugMode&&this.debugToggler._getInternalSplitters&&console.log("💟💟💟 currentElementBottom > floater, \ntry to split",u);const o=this._getProcessedChildren(u,i,r);if(o.length)c(t),g.push(M),this._getInternalSplitters({rootNode:e,rootComputedStyle:h,children:o,pageBottom:i,firstPartHeight:n,fullPageHeight:r,result:s,trail:l[t].children=[],indexTracker:a,stack:g}),g.pop(),this.debugMode&&this.debugToggler._getInternalSplitters&&console.log("🟪 back from _getInternalSplitters;\n trail[i]",l[t]);else if(d&&this._isNoHanging(d)){console.warn("tst improveResult",d);let e=d;e=this.DOM.findFirstChildParent(e,this.contentFlow)||e,e=this.DOM.findPreviousNoHangingsFromPage(e,this.pages.at(-2)?.pageBottom,this.root)||e,this.debugMode&&this.debugToggler._getInternalSplitters&&console.log("previousElement _isNoHanging"),p(e,t-1)}else this.debugMode&&this.debugToggler._getInternalSplitters&&console.log(u,"currentElement has no children"),p(u,t)}}}return c(),e.style.position=d,this.debugMode&&this.debugToggler._getInternalSplitters&&console.groupEnd(),{result:s,trail:l}}_splitGridNode(e,t,o){const i=["%c_splitGridNode\n","color:white"];this.debugMode&&this.debugToggler._splitGridNode&&console.group("_splitGridNode");const n=this._getChildren(e);this.debugMode&&this.debugToggler._splitGridNode&&console.log(...i,"children",n);const r=n.reduce(((e,t,o,n)=>{const r=this.DOM.getComputedStyle(t),s=r.getPropertyValue("grid-column-start"),l=r.getPropertyValue("grid-column-end"),a={element:t,start:"auto"===s?"auto":parseInt(r.getPropertyValue("grid-column-start")),end:"auto"===l?"auto":parseInt(r.getPropertyValue("grid-column-end")),top:this.DOM.getElementTop(t)};return this.debugMode&&this.debugToggler._splitGridNode&&console.log(...i,"{ ???",t,e),!e.length||e.at(-1).at(-1).start>=a.start||"auto"===e.at(-1).at(-1).start||"auto"===a.start?(e.at(-1)&&this._isNoHanging(e.at(-1).at(-1).element)?(this.debugMode&&this.debugToggler._splitGridNode&&console.log("%cLAST","color:red"),e.at(-1).push(a)):e.push([a]),this.debugMode&&this.debugToggler._splitGridNode&&console.log(...i,"IF new:",a,[...e]),e):e.length&&e.at(-1).at(-1).start<a.start?(e.at(-1).push(a),this.debugMode&&this.debugToggler._splitGridNode&&console.log(...i,"IF new:",a,[...e]),e):void(this.debugMode&&console.assert(!0,"_splitGridNode: An unexpected case of splitting a grid.","\nOn the element:",t))}),[]);this.debugMode&&this.debugToggler._splitGridNode&&console.log(...i,"childrenGroups",r);const s=r.length,l=this.DOM.getElementHeight(e);if(s<this.minBreakableGridRows&&l<o)return[];const a=[...r.map((e=>e.map((e=>e.top)).sort())).map((e=>e[0])),l];this.debugMode&&this.debugToggler._splitGridNode&&console.log(...i,"topRowPoints",a);const g=this.DOM.getElementRootedTop(e,this.root),h=this.DOM.getEmptyNodeHeight(e),d=t-g-h,c=o-h;this.debugMode&&this.debugToggler._splitGridNode&&console.log("firstPartHeight",d),this.debugMode&&this.debugToggler._splitGridNode&&console.log("fullPagePartHeight",c);const p=a;let u=[],m=d;for(let e=0;e<p.length;e++)p[e]>m&&(e>this.minLeftRows&&u.push(e-1),m=p[e-1]+c);this.debugMode&&this.debugToggler._splitGridNode&&console.log("splitsIds",u);const b=(t,o)=>{this.debugMode&&this.debugToggler._splitGridNode&&console.log(...i,`=> insertGridSplit(${t}, ${o})`);const n=r.slice(t,o).flat().map((e=>e.element));this.debugMode&&this.debugToggler._splitGridNode&&console.log(...i,"partEntries",n);const s=this.DOM.cloneNodeWrapper(e);return this.DOM.copyNodeWidth(s,e),this.DOM.setFlagNoBreak(s),e.before(s),this.DOM.insertAtEnd(s,...n),s},M=u.map(((e,t,o)=>b(o[t-1]||0,e)));return this.debugMode&&this.debugToggler._splitGridNode&&console.log(...i,"splits",M),this.DOM.setFlagNoBreak(e),this.debugMode&&this.debugToggler._splitGridNode&&console.groupEnd(),[...M,e]}_splitTextNode(e,t,o){const i=this.DOM.getElementRootedTop(e,this.root),n=this.DOM.getElementHeight(e),r=this.DOM.getLineHeight(e),s=function({pageLines:e,nodeLines:t,firstPartLines:o,minBreakableLines:i,minLeftLines:n,minDanglingLines:r}){let s=[];if(t<i)return[];o<n&&(o=e),function i(n=0){const r=e*n+o,l=n?r-e*(n-1):o;if(t>r)return s=[...s,{endLine:r,splitter:r/t,partLines:l}],void i(n+1);const a=t-(r-e);s=[...s,{endLine:null,splitter:null,partLines:a}]}();const l=s.length-2,a=s.length-1;if(s[a].partLines<r){const e=r-s[a].partLines,o=s[l].endLine-e,i=o/t;s[l]={endLine:o,splitter:i,partLines:s[l].partLines-e},s[a].partLines=s[a].partLines+e}return s}({nodeLines:~~(n/r),pageLines:~~(o/r),firstPartLines:~~((t-i)/r),minBreakableLines:this.minBreakableLines,minLeftLines:this.minLeftLines,minDanglingLines:this.minDanglingLines});if(s.length<2)return[];const{splittedNode:l,nodeWords:a,nodeWordItems:g}=this.DOM.prepareSplittedNode(e),h=s.map((({endLine:e,splitter:t})=>t?function({arr:e,floater:t,topRef:o,getElementTop:i,root:n}){const r=(t,s)=>{const l=t+1,a=e[l],g=i(a,n);return s<g&&g>=o?l:r(l,g)},s=(t,r)=>{const l=t-1,a=e[l],g=i(a,n);return g<r&&r>=o?t:s(l,g)},l=~~(e.length*t),a=i(e[l],n);return a<o?r(l,a):s(l,a)}({arr:g,floater:t,topRef:e*r,getElementTop:this.DOM.getElementRelativeTop,root:this.root}):null)).map(((e,t,o)=>{const i=this.DOM.createWithFlagNoBreak(),n=o[t-1]||0,r=e||o[o.length];return this.DOM.setInnerHTML(i,a.slice(n,r).join("")+""),i}));return this.DOM.insertInsteadOf(l,...h),h}_getChildren(e){if(this.DOM.isComplexTextBlock(e))return[...this.DOM.getChildren(e)];{let t=[...this.DOM.getChildNodes(e)].reduce(((e,t)=>{if(this._isSTYLE(t))return e;if(this.DOM.isSignificantTextNode(t))return e.push(this.DOM.wrapTextNode(t)),e;if(!this.DOM.getElementOffsetParent(t)){const o=this._getChildren(t);return o.length>0&&e.push(...o),e}return this.DOM.isElementNode(t)?(e.push(t),e):void 0}),[]);return this._isVerticalFlowDisrupted(t)&&(t=this._processInlineChildren(t)),t}}_isSignificantChild(e){const t=this.DOM.getElementTagName(e);return"A"!==t&&"TT"!==t&&this.DOM.getElementHeight(e)>0}_prepareNoHangingSelector(e){return["H1","H2","H3","H4","H5","H6",...e?.length?e?.split(/\s+/):[]]}_prepareForcedPageBreakSelector(e){return[...this._arrayFromString(e),this.selector.printForcedPageBreak]}_arrayFromString(e){return e?.length?e?.split(/\s+/):[]}_isSTYLE(e){return"STYLE"===this.DOM.getElementTagName(e)}_isPRE(e,t=this.DOM.getComputedStyle(e)){return["block"].includes(t.display)&&["pre","pre-wrap","pre-line","break-spaces","nowrap"].includes(t.whiteSpace)}_isIMG(e){return"IMG"===this.DOM.getElementTagName(e)}_isSVG(e){return"svg"===this.DOM.getElementTagName(e)}_isTextNode(e){return this.DOM.isWrappedTextNode(e)}_isTableNode(e,t=this.DOM.getComputedStyle(e)){return"TABLE"===this.DOM.getElementTagName(e)||["table"].includes(t.display)}_isTableLikeNode(e,t=this.DOM.getComputedStyle(e)){return"TABLE"!==this.DOM.getElementTagName(e)&&["table"].includes(t.display)}_isLiNode(e){return"LI"===this.DOM.getElementTagName(e)}_isNoBreak(e,t=this.DOM.getComputedStyle(e)){return this.DOM.isNoBreak(e)||this.DOM.isInlineBlock(t)||this._notSolved(e)}_isNoHanging(e){return this.DOM.isNoHanging(e)}_notSolved(e){return"OBJECT"===this.DOM.getElementTagName(e)}}class h{constructor({config:e,DOM:t,selector:o,layout:i}){this._debugMode=e.debugMode,this._DOM=t,this._selector=o,this._frontpageTemplate=i.frontpageTemplate,this._headerTemplate=i.headerTemplate,this._footerTemplate=i.footerTemplate,this._paperBodySelector=o?.paperBody||".paperBody",this._paperHeaderSelector=o?.paperHeader||".paperHeader",this._paperFooterSelector=o?.paperFooter||".paperFooter",this._headerContentSelector=o?.headerContent||".headerContent",this._footerContentSelector=o?.footerContent||".footerContent",this._frontpageContentSelector=o?.frontpageContent||".frontpageContent",this._virtualPaperSelector=o?.virtualPaper||".virtualPaper",this._virtualPaperTopMarginSelector=o?.virtualPaperTopMargin||".virtualPaperTopMargin",this._virtualPaperBottomMarginSelector=o?.virtualPaperBottomMargin||".virtualPaperBottomMargin",this._pageNumberRootSelector=o?.pageNumberRoot||void 0,this._pageNumberCurrentSelector=o?.pageNumberCurrent||void 0,this._pageNumberTotalSelector=o?.pageNumberTotal||void 0,this._paperHeight,this._frontpageFactor,this.headerHeight,this.footerHeight,this.bodyHeight,this.bodyWidth,this._calculatePaperParams()}create({currentPage:e,totalPages:t}){const o=this._createPaperBody(this.bodyHeight),i=this._createPaperHeader(this._headerTemplate),n=this._createPaperFooter(this._footerTemplate);return this._createPaper({header:i,body:o,footer:n,currentPage:e,totalPages:t})}createFrontpage({currentPage:e,totalPages:t}){const o=this._createFrontpageContent(this._frontpageTemplate,this._frontpageFactor),i=this._createPaperBody(this.bodyHeight,o),n=this._createPaperHeader(this._headerTemplate),r=this._createPaperFooter(this._footerTemplate);return this._createPaper({header:n,body:i,footer:r,currentPage:e,totalPages:t})}createVirtualTopMargin(){return this._DOM.create(this._virtualPaperTopMarginSelector)}createVirtualBottomMargin(){return this._DOM.create(this._virtualPaperBottomMarginSelector)}_createPaper({header:e,body:t,footer:o,currentPage:i,totalPages:n}){const r=this._DOM.create(this._virtualPaperSelector);return this._DOM.insertAtEnd(r,this.createVirtualTopMargin(),e,t,o,this.createVirtualBottomMargin()),i&&n&&(this._setPageNumber(e,i,n),this._setPageNumber(o,i,n)),r}_createFrontpageContent(e,t){const o=this._DOM.create(this._frontpageContentSelector);return e&&this._DOM.setInnerHTML(o,e),t&&this._DOM.setStyles(o,{transform:`scale(${t})`}),o}_createPaperBody(e,t){const o=this._DOM.create(this._paperBodySelector);return this._DOM.setStyles(o,{height:e+"px"}),t&&this._DOM.insertAtEnd(o,t),o}_createPaperHeader(e){const t=this._DOM.create(this._paperHeaderSelector);if(e){const o=this._DOM.create(this._headerContentSelector);this._DOM.setInnerHTML(o,e),this._DOM.insertAtEnd(t,o)}return t}_createPaperFooter(e){const t=this._DOM.create(this._paperFooterSelector);if(e){const o=this._DOM.create(this._footerContentSelector);this._DOM.setInnerHTML(o,e),this._DOM.insertAtEnd(t,o)}return t}_setPageNumber(e,t,o){const i=this._pageNumberRootSelector?this._DOM.getElement(this._pageNumberRootSelector,e):this._pageNumberRootSelector;if(i){const e=this._DOM.getElement(this._pageNumberCurrentSelector,i),n=this._DOM.getElement(this._pageNumberTotalSelector,i);this._DOM.setInnerHTML(e,t),this._DOM.setInnerHTML(n,o)}}_calculatePaperParams(){const e=this._createPaperBody(),t=this._createFrontpageContent(this._frontpageTemplate),o=this._createPaperHeader(this._headerTemplate),i=this._createPaperFooter(this._footerTemplate),n=this._createPaper({header:o,body:e,footer:i}),r=this._DOM.create("#workbench");this._DOM.setStyles(r,{position:"absolute",left:"-3000px"}),this._DOM.insertAtEnd(r,n),this._DOM.insertAtStart(this._DOM.body,r);const s=this._DOM.getElementBCR(n).height,l=this._DOM.getElementHeight(o)||0,a=this._DOM.getElementHeight(i)||0,g=this._DOM.getElementHeight(e),h=this._DOM.getElementWidth(e);this._DOM.insertAtStart(e,t);const d=this._DOM.getElementHeight(e),c=d>g?g/d:1;this._DOM.removeNode(r),l>.2*s&&console.warn("It seems that your custom header is too high"),a>.15*s&&console.warn("It seems that your custom footer is too high"),c<1&&console.warn("It seems that your frontpage content is too large. We made it smaller to fit on the page. Check out how it looks! It might make sense to fix this with styles or reduce the text amount."),this._paperHeight=s,this.headerHeight=l,this.footerHeight=a,this.bodyHeight=g,this.bodyWidth=h,this._frontpageFactor=c}}const d="border:1px solid #ee00ee;background:#EEEEEE;color:#ee00ee;";class c{constructor({config:e,DOM:t,selector:o,pages:i,layout:n,paper:r}){this.config=e,this.debugMode=e.debugMode,this.DOM=t,this.selector=o,this.virtualPaperGapSelector=o?.virtualPaperGap,this.runningSafetySelector=o?.runningSafety,this.printPageBreakSelector=o?.printPageBreak,this.pageDivider=o?.pageDivider,this.virtualPaper=o?.virtualPaper,this.virtualPaperTopMargin=o?.virtualPaperTopMargin,this.paperBody=o?.paperBody,this.pages=i,this.root=n.root,this.contentFlow=n.contentFlow,this.paperFlow=n.paperFlow,this.paper=r,this.hasFrontPage=!!n.frontpageTemplate}create(){this.debugMode&&console.groupCollapsed("%c Preview ",d),this._processFirstPage(),this._processOtherPages(),(!0===this.config.mask||"true"===this.config.mask)&&this._addMask(),this.debugMode&&console.groupEnd("%c Preview ",d)}_addMask(){const e=[...this.paperFlow.querySelectorAll(this.virtualPaper)],t=this.DOM.getElementTop(e.at(-1))/(e.length-1),o=this.DOM.getElementHeight(this.paperFlow.querySelector(this.virtualPaperTopMargin)),i=this.DOM.getElementHeight(this.paperFlow.querySelector(this.paperBody));!function({targetElement:e,maskHeight:t,maskWindow:o,maskTopPosition:i}){e.style=`\n    -webkit-mask-image: linear-gradient(\n      black 0,\n      black ${o}px,\n      transparent ${o}px,\n      transparent ${t}px\n    );\n            mask-image: linear-gradient(\n              black 0,\n              black ${o}px,\n              transparent ${o}px,\n              transparent ${t}px\n            );\n    -webkit-mask-repeat: no-repeat;\n            mask-repeat: no-repeat;\n    -webkit-mask-size: 100% ${t}px;\n            mask-size: 100% ${t}px;\n    -webkit-mask-position: 100% ${i}px;\n            mask-position: 100% ${i}px;\n    -webkit-mask-repeat: repeat-y;\n            mask-repeat: repeat-y;\n    -webkit-mask-origin: border-box;\n            mask-origin: border-box;\n    `}({targetElement:this.contentFlow,maskHeight:t,maskWindow:i,maskTopPosition:o})}_processFirstPage(){let e;if(this.hasFrontPage){const t=this._insertFrontpageSpacer(this.contentFlow,this.paper.bodyHeight);this.pages.unshift({pageStart:t}),e=this.paper.createFrontpage({currentPage:1,totalPages:this.pages.length})}else e=this.paper.create({currentPage:1,totalPages:this.pages.length});this._insertIntoPaperFlow(e),this._insertIntoContentFlow(0)}_processOtherPages(){for(let e=1;e<this.pages.length;e++){const t=this.paper.create({currentPage:e+1,totalPages:this.pages.length}),o=this._createVirtualPaperGap();this._insertIntoPaperFlow(t,o),this._insertIntoContentFlow(e,o)}}_insertIntoPaperFlow(e,t){this._insertPaper(this.paperFlow,e,t)}_insertIntoContentFlow(e,t){const o=this.pages[e].pageStart,i=this._createPageBreaker(e,t);this.DOM.insertBefore(o,i),t&&this._insertFooterSpacer(i,this.paper.footerHeight,t),this._insertHeaderSpacer(i,this.paper.headerHeight),this._updatePageStartElementAttrValue(o,e)}_createPageBreaker(e,t){const o=this.DOM.create(this.pageDivider);return this.DOM.setAttribute(o,"[page]",`${e+1}`),t&&this.paper.footerHeight&&this.DOM.setStyles(o,{marginTop:this.paper.footerHeight-1+"px"}),this.paper.headerHeight&&this.DOM.setStyles(o,{marginBottom:this.paper.headerHeight-1+"px"}),o}_updatePageStartElementAttrValue(e,t){this.hasFrontPage&&this.DOM.markPageStartElement(e,`${t+1}`)}_insertPaper(e,t,o){o?this.DOM.insertAtEnd(e,o,t):this.DOM.insertAtEnd(e,t)}_createVirtualPaperGap(){return this.DOM.create(this.virtualPaperGapSelector)}_createVirtualPaperTopMargin(){return this.paper.createVirtualTopMargin()}_createVirtualPaperBottomMargin(){return this.paper.createVirtualBottomMargin()}_insertFrontpageSpacer(e,t){const o=this.DOM.create();return this.DOM.setStyles(o,{paddingBottom:t+"px"}),this.DOM.setAttribute(o,".printFrontpageSpacer"),this.DOM.insertAtStart(e,o),o}_insertHeaderSpacer(e,t){const o=this.DOM.createDocumentFragment(),i=this.DOM.create(this.runningSafetySelector);this.DOM.insertAtEnd(o,this._createVirtualPaperTopMargin(),i),this.DOM.insertAtEnd(e,o)}_insertFooterSpacer(e,t,o){const i=this.DOM.createDocumentFragment(),n=this._createVirtualPaperGap(),r=this.DOM.create(this.runningSafetySelector);this.DOM.insertAtEnd(i,r,this._createVirtualPaperBottomMargin(),this.DOM.create(this.printPageBreakSelector),n),this.DOM.insertAtStart(e,i),this._balanceFooter(r,n,o)}_balanceFooter(e,t,o){const i=this.DOM.getElementRootedTop(o,this.root)-this.DOM.getElementRootedTop(t,this.root);this.DOM.setStyles(e,{marginBottom:i+"px"}),this.debugMode&&console.assert(i>=0,`balancer is negative: ${i} < 0`,t)}}class p{constructor({config:e,DOM:t,selector:o,layout:i}){this.config=e,this.debugMode=e.debugMode,this.tocPageNumberSelector=e.tocPageNumberSelector,this.selector=o,this.DOM=t,this.layout=i,this.contentFlow=i.contentFlow,this.root=i.root,this.pageDividerSelector=o.pageDivider,this.debugToggler={_:!1}}render(){this.config.debugMode&&console.time("Processing TOC"),this.debugMode&&this.debugToggler._&&console.log(`\n📑 TOC: I am here!\n\ntocPageNumberSelector:\n • ${this.tocPageNumberSelector}\n pageDividerSelector:\n • ${this.pageDividerSelector}\n      `);const e=this.DOM.findAllSelectorsInside(this.contentFlow,this.tocPageNumberSelector);if(this.debugMode&&this.debugToggler._&&console.log("📑 tocPageNumberBoxes",e.length),!e.length)return void(this.debugMode&&this.debugToggler._&&console.log("📑 no valid toc"));const t=this.DOM.findAllSelectorsInside(this.contentFlow,this.pageDividerSelector).reduce(((e,t,o)=>{const i=this.DOM.getElementRootedTop(t,this.root)-1,n=this.DOM.getAttribute(t,"[page]");return e[i]=n,e}),{});this.debugMode&&this.debugToggler._&&console.log("📑 dataFromPagesMarkers",t);const o=e.reduce(((e,t)=>{const o=this.DOM.getDataId(t),i=this.DOM.getElementById(o),n=this.DOM.getElementRootedTop(i,this.root);return e[n]={box:t,id:o,targetTop:n},e}),{});this.debugMode&&this.debugToggler._&&console.log("📑 dataFromTOC",o);const i={...t,...o};let n=0;this.debugMode&&this.debugToggler._&&console.groupCollapsed("Processing obj");for(const e in i){const t=i[e];this.debugMode&&this.debugToggler._&&console.log(`Processing ${e}: ${t}`),"string"==typeof t?n=t:(t.page=n,this.DOM.setInnerHTML(t.box,n))}this.debugMode&&this.debugToggler._&&console.groupEnd("Processing obj"),this.debugMode&&this.debugToggler._&&console.log("📑 tocObject",i),this.config.debugMode&&console.timeEnd("Processing TOC")}}class u{constructor({config:e,DOM:t,selector:o}){this._config=e,this._selector=o,this._DOM=t}init(){this._config.debugMode&&console.log("🐙 i am Validator!");const e=`${this._selector.paperFlow} ${this._selector.virtualPaperGap}`,t=`${this._selector.contentFlow} ${this._selector.virtualPaperGap}`,o=[...this._DOM.getAllElements(e)].map((e=>e.offsetTop)),i=[...this._DOM.getAllElements(t)].map((e=>e.offsetTop)),n=o.reduce(((e,t,o)=>(t!==i[o]&&e.push(o+1),e)),[]);console.assert(!n.length,"Problems with preview generation on the following pages: ",n)}}const m="border:1px dashed #cccccc;background:#ffffff;color:#cccccc;",b=document.currentScript.dataset,M=new class{constructor(t){this.params=t,this.selector=e,this.config}render(){console.time("HTML2PDF4DOC time"),this.config=function(t){let o={debugMode:!1,preloader:!1,preloaderTarget:!1,preloaderBackground:!1,mask:!1,noHangingSelectors:!1,forcedPageBreakSelectors:!1,pageBreakBeforeSelectors:!1,pageBreakAfterSelectors:!1,noBreakSelectors:!1,tocPageNumberSelector:"html2pdf-toc-page-number",printLeftMargin:"21mm",printRightMargin:"21mm",printTopMargin:"12mm",printBottomMargin:"12mm",printFontSize:"12pt",printWidth:"210mm",printHeight:"297mm",headerMargin:"16px",footerMargin:"16px",virtualPagesGap:"16px"};const i={printWidth:"210mm",printHeight:"297mm"},n={printWidth:"148.5mm",printHeight:"210mm"};switch(t.printPaperSize){case"A5":case"a5":o={...o,...n};break;default:o={...o,...i}}o={...o,initialRoot:e.init,tocPageNumberSelector:e.tocPageNumber,...t},console.info("HTML2PDF4DOC config:",o);const r={printLeftMargin:o.printLeftMargin,printRightMargin:o.printRightMargin,printTopMargin:o.printTopMargin,printBottomMargin:o.printBottomMargin,printFontSize:o.printFontSize,printWidth:o.printWidth,printHeight:o.printHeight,headerMargin:o.headerMargin,footerMargin:o.footerMargin,virtualPagesGap:o.virtualPagesGap},s=document.createElement("div");return s.style="\n  position:absolute;\n  z-index:1000;\n  left: 200%;\n  ",document.body.append(s),Object.entries(r).forEach((([e,t])=>{s.style.width=t,r[e]=`${Math.trunc(s.getBoundingClientRect().width)}px`})),s.remove(),o={...o,...r},o}(this.params);const o=new t({DOM:window.document,debugMode:this.config.debugMode}),i=new r({config:this.config,DOM:o,selector:this.selector}),s=new n({config:this.config,DOM:o,selector:this.selector});if(s.create(),!s.success)return void console.error("Failed to create layout.\n\nWe have to interrupt the process of creating PDF preview. ");const l=new h({config:this.config,DOM:o,selector:this.selector,layout:s}),a=new g({config:this.config,DOM:o,selector:this.selector,node:i,layout:s,referenceHeight:l.bodyHeight,referenceWidth:l.bodyWidth}).calculate();new c({config:this.config,DOM:o,selector:this.selector,layout:s,paper:l,pages:a}).create(),new p({config:this.config,DOM:o,selector:this.selector,layout:s}).render(),new u({config:this.config,DOM:o,selector:this.selector,layout:s}).init(),console.timeEnd("HTML2PDF4DOC time")}}(b),f=new class{constructor(e){this.debugMode=e.debugMode,this.preloader,this.preloaderTarget=document.querySelector(e.preloaderTarget)||document.body,this.preloaderBackground=e.preloaderBackground||"white"}create(){this.debugMode&&console.groupCollapsed("%c Preloader ",m),this._insertStyle(),this.preloader=document.createElement("div"),this.preloader.classList.add("lds-dual-ring"),this.preloaderTarget.append(this.preloader),this.debugMode&&console.groupEnd("%c Preloader ",m)}remove(){if(!this.preloader)return;let e=1;const t=setInterval((()=>{e<=.1&&(clearInterval(t),this.preloader.remove()),this.preloader.style.opacity=e,e-=.1*e}),50);this.debugMode&&console.log("%c Preloader removed ",m)}_insertStyle(){const e=document.querySelector("head"),t=document.createElement("style");t.append(document.createTextNode(this._css())),t.setAttribute("data-preloader-style",""),e.append(t)}_css(){return`\n    /* PRELOADER */\n    .lds-dual-ring {\n      position: absolute;\n      z-index: 99999;\n      top: 0; left: 0; bottom: 0; right: 0;\n      background: ${this.preloaderBackground};\n      display: flex;\n      justify-content: center;\n      align-items: center;\n    }\n    /*\n    .lds-dual-ring:after {\n      content: " ";\n      display: block;\n      width: 64px;\n      height: 64px;\n      margin: 8px;\n      border-radius: 50%;\n      border: 6px solid #eee;\n      border-color: #eee transparent #eee transparent;\n      animation: lds-dual-ring 1.2s linear infinite;\n    }\n    @keyframes lds-dual-ring {\n      0% {\n        transform: rotate(0deg);\n      }\n      100% {\n        transform: rotate(360deg);\n      }\n    }\n    */\n  `}}(b);window.addEventListener("load",(function(e){M.render()})),"true"===b.preloader&&(window.addEventListener("DOMContentLoaded",(function(e){f.create()})),window.addEventListener("load",(function(e){f.remove()})))})();